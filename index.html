<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HealthOS Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/180/4a90e2/scale-tool.png">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js" crossorigin></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        /* iOS Safe Area Variables */
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }

        /* Base Reset */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            background-color: #F2F2F7;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Prevents pull-to-refresh on iOS PWA */
        }
        .dark body { background-color: #000000; }
        
        /* Layout Utilities */
        .pt-safe { padding-top: max(20px, var(--sat)); }
        .pb-safe { padding-bottom: max(20px, var(--sab)); }
        .h-dvh { height: 100dvh; } /* Dynamic viewport height */
        
        /* Glassmorphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1);
        }
        .dark .glass {
            background: rgba(28, 28, 30, 0.85);
            border-top: 0.5px solid rgba(255,255,255,0.15);
        }
        
        /* Utility: Hide Scrollbars */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Spreadsheet Sticky Headers/Columns */
        .sticky-col { position: sticky; left: 0; z-index: 20; }
        .sticky-head { position: sticky; top: 0; z-index: 30; }
        .sticky-corner { position: sticky; top: 0; left: 0; z-index: 40; }
    </style>
    
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', blue: '#007AFF' }
                    }
                }
            }
        }
    </script>
</head>
<body>
<div id="fatal-error-screen" style="display:none; position:fixed; inset:0; z-index:9999; background:#fff; padding:40px; font-family:sans-serif;">
    <div style="max-width:400px; margin:auto; text-align:center;">
        <div style="font-size:50px; margin-bottom:20px;">⚠️</div>
        <h1 style="font-size:22px; margin:0 0 10px; color:#000;">App Initialization Failed</h1>
        <p id="error-desc" style="color:#666; font-size:14px; line-height:1.5; margin-bottom:20px;">
            The application encountered a fatal error during startup.
        </p>
        <div style="background:#f4f4f4; padding:15px; border-radius:8px; text-align:left; margin-bottom:20px;">
            <code id="error-code" style="font-family:monospace; font-size:12px; color:#d00; word-break:break-all;">CODE: UNKNOWN_FATAL_ERR</code>
        </div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="location.reload()" style="background:#000; color:#fff; border:none; padding:12px 24px; border-radius:8px; font-weight:bold; cursor:pointer;">Try Again</button>
            <button id="copy-err-btn" style="background:#e2e2e7; color:#000; border:none; padding:12px 24px; border-radius:8px; font-weight:bold; cursor:pointer;">Copy Full Error</button>
        </div>
    </div>
</div>

<script>
    let lastError = "";

    function showFatalError(code, desc) {
        lastError = `ID: ${code}\nDescription: ${desc}\nUserAgent: ${navigator.userAgent}\nTime: ${new Date().toISOString()}`;
        document.getElementById('fatal-error-screen').style.display = 'block';
        document.getElementById('error-code').innerText = 'ERROR_ID: ' + code;
        if(desc) document.getElementById('error-desc').innerText = desc;
    }

    // 1. CATCH SCRIPT LOAD FAILURES
    window.addEventListener('error', function(e) {
        if (e.target.tagName === 'SCRIPT') {
            showFatalError('RESOURCE_LOAD_FAIL', 'Failed to load: ' + e.target.src);
        }
    }, true);

    // 2. CATCH RUNTIME CRASHES
    window.onerror = function(msg, url, line, col, error) {
        const detail = `${msg} | URL: ${url} | Line: ${line} | Col: ${col}`;
        showFatalError('RUNTIME_EXCEPTION', detail);
        return false;
    };

    // 3. COPY BUTTON LOGIC
    document.getElementById('copy-err-btn').onclick = function() {
        navigator.clipboard.writeText(lastError).then(() => {
            this.innerText = "Copied!";
            setTimeout(() => { this.innerText = "Copy Full Error"; }, 2000);
        });
    };
</script>

    <div id="root"></div>

    <script type="text/babel">
        // ============================================
        // 1. INITIALIZATION & CONSTANTS
        // ============================================
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        
        // Safety check for Framer Motion to prevent crashes if CDN lags
        const MotionLib = window.Motion || { motion: { div: 'div', button: 'button' }, AnimatePresence: ({children}) => children };
        const { motion, AnimatePresence } = MotionLib;

   

        // --- THEME CONFIGURATION ---
        const THEMES = {
            monochrome: { id: 'monochrome', label: 'Noir', bg: 'bg-black dark:bg-white', text: 'text-black dark:text-white', accent: 'bg-black dark:bg-white text-white dark:text-black', icon: 'text-black dark:text-white' },
            ocean: { id: 'ocean', label: 'Ocean', bg: 'bg-blue-600', text: 'text-blue-600', accent: 'bg-blue-500 text-white', icon: 'text-blue-500' },
            forest: { id: 'forest', label: 'Forest', bg: 'bg-emerald-600', text: 'text-emerald-600', accent: 'bg-emerald-600 text-white', icon: 'text-emerald-600' },
            mint: { id: 'mint', label: 'Mint', bg: 'bg-teal-400', text: 'text-teal-500', accent: 'bg-teal-400 text-white', icon: 'text-teal-400' },
            bubblegum: { id: 'bubblegum', label: 'Bubblegum', bg: 'bg-pink-500', text: 'text-pink-500', accent: 'bg-pink-500 text-white', icon: 'text-pink-500' },
            rose: { id: 'rose', label: 'Rose', bg: 'bg-rose-300', text: 'text-rose-400', accent: 'bg-rose-300 text-white', icon: 'text-rose-400' },
        };

        // --- METRICS CONFIGURATION ---
        // Defines the type of data, labels, and if they are user-inputtable or calculated
        const METRICS = {
            weight: { label: 'Weight', unitType: 'mass', input: true },
            bmi: { label: 'BMI', unitType: 'index', input: false }, // Calculated
            bodyFat: { label: 'Body Fat', unitType: 'percent', input: true },
            fatMass: { label: 'Fat Mass', unitType: 'mass', input: false }, // Calculated
            leanMass: { label: 'Fat Free Mass', unitType: 'mass', input: false }, // Calculated
            visceralFat: { label: 'Visceral Fat', unitType: 'index', input: true },
            bodyWater: { label: 'Body Water', unitType: 'percent', input: true },
            skeletalMuscle: { label: 'Skeletal Muscle', unitType: 'percent', input: true },
            muscleMass: { label: 'Muscle Mass', unitType: 'mass', input: false }, // Calculated
            boneMass: { label: 'Bone Mass', unitType: 'mass', input: true },
            bmr: { label: 'BMR', unitType: 'cal', input: true },
        };

        // ============================================
        // 2. DATABASE & UTILITIES
        // ============================================
        
        // Dexie.js Database Definition
        const db = new Dexie('HealthOS_Pro_V1');
        db.version(1).stores({
            entries: 'date', 
            settings: 'key',
            goals: 'id'
        });

        // Conversion Helpers
        const convert = (val, type, toUnit) => {
            if (val === null || val === undefined || isNaN(val)) return 0;
            const num = parseFloat(val);
            if (type === 'percent' || type === 'index' || type === 'cal') return num;
            
            // Convert KG -> LBS if imperial
            if (type === 'mass') {
                if (toUnit === 'imperial') return num * 2.20462; 
                return num; 
            }
            return num;
        };

        // Input Helpers (Convert Display Unit -> Storage Unit)
        const fromInput = (val, type, currentUnit) => {
            if (!val) return null;
            const num = parseFloat(val);
            // Convert LBS -> KG for storage if imperial
            if (type === 'mass' && currentUnit === 'imperial') return num / 2.20462;
            return num;
        };

        const formatVal = (val, type, unit) => {
            if (!val && val !== 0) return '-';
            const converted = convert(val, type, unit);
            if (type === 'cal') return Math.round(converted);
            return converted.toFixed(1);
        };

        const getUnitLabel = (type, unit) => {
            if (type === 'percent') return '%';
            if (type === 'index') return '';
            if (type === 'cal') return 'kcal';
            return unit === 'imperial' ? 'lbs' : 'kg';
        };

        // ============================================
        // 3. REACT COMPONENTS
        // ============================================

        // --- Error Boundary (Prevent total app crash) ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("HealthOS Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) return <div className="p-10 text-center text-gray-500">Something went wrong. Please refresh.</div>;
                return this.props.children; 
            }
        }

        // --- Tab: Dashboard (Today) ---
        const TodayTab = ({ goals, entries, theme, unit }) => {
            const sorted = useMemo(() => [...entries].sort((a,b) => new Date(a.date) - new Date(b.date)), [entries]);
            const first = sorted[0];
            const latest = sorted[sorted.length - 1];
            const activeGoals = goals.filter(g => g.enabled);

            return (
                <div className="h-full pt-safe px-6 pb-24 overflow-y-auto no-scrollbar">
                    <div className="mt-12 mb-8">
                        <h2 className="text-gray-500 font-semibold uppercase tracking-wider text-xs mb-1">Dashboard</h2>
                        <h1 className="text-4xl font-bold text-gray-900 dark:text-white tracking-tight">
                            {new Date().toLocaleDateString('en-US', { weekday: 'long' })}
                        </h1>
                    </div>

                    <div className="space-y-4">
                        {activeGoals.length === 0 ? (
                            <div className="p-8 text-center border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl">
                                <p className="text-gray-400">No active goals set.</p>
                            </div>
                        ) : (
                            activeGoals.map(goal => {
                                const m = METRICS[goal.key];
                                const curVal = latest ? latest[goal.key] : 0;
                                const startVal = first ? first[goal.key] : 0;
                                const goalVal = parseFloat(goal.target);

                                const dispCur = convert(curVal, m.unitType, unit);
                                const dispStart = convert(startVal, m.unitType, unit);
                                
                                const delta = dispCur - dispStart;
                                const pct = (dispCur / goalVal) * 100; // Simplified progress logic

                                return (
                                    <div key={goal.id} className="bg-white dark:bg-[#1C1C1E] rounded-3xl p-5 shadow-sm">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <div className={`text-xs font-bold uppercase tracking-wider mb-1 ${THEMES[theme].icon}`}>{m.label}</div>
                                                <div className="flex items-baseline gap-1">
                                                    <span className="text-3xl font-bold dark:text-white">{formatVal(curVal, m.unitType, unit)}</span>
                                                    <span className="text-sm text-gray-400 font-medium">{getUnitLabel(m.unitType, unit)}</span>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className={`text-lg font-bold ${delta > 0 ? 'text-green-500' : delta < 0 ? 'text-blue-500' : 'text-gray-400'}`}>
                                                    {delta > 0 ? '+' : ''}{delta.toFixed(1)} <span className="text-xs">{getUnitLabel(m.unitType, unit)}</span>
                                                </div>
                                                <div className="text-[10px] text-gray-400 uppercase">Change</div>
                                            </div>
                                        </div>
                                        <div className="relative pt-2">
                                            <div className="flex justify-between text-xs text-gray-400 mb-1 font-medium">
                                                <span>{Math.max(0, Math.min(100, pct)).toFixed(0)}%</span>
                                                <span>Target: {goalVal}</span>
                                            </div>
                                            <div className="h-2 w-full bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                                                <motion.div 
                                                    initial={{ width: 0 }}
                                                    animate={{ width: `${Math.max(5, Math.min(100, pct))}%` }}
                                                    className={`h-full ${THEMES[theme].bg}`}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                )
                            })
                        )}
                    </div>
                </div>
            );
        };

        // --- Tab: Trends (Chart.js) ---
        const TrendsTab = ({ entries, unit, theme }) => {
            const [activeKey, setActiveKey] = useState('weight');
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || entries.length < 2) return;

                const ctx = canvasRef.current.getContext('2d');
                if (chartRef.current) chartRef.current.destroy();

                // Sort & Prepare Data
                const sorted = [...entries].sort((a,b) => new Date(a.date) - new Date(b.date));
                const labels = sorted.map(e => e.date);
                const metric = METRICS[activeKey];
                const values = sorted.map(e => convert(e[activeKey], metric.unitType, unit));
                
                // --- Simple Linear Regression for Prediction ---
                const n = values.length;
                let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
                values.forEach((y, x) => { sumX += x; sumY += y; sumXY += x * y; sumXX += x * x; });
                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                
                // Calculate Future Points (Next 7 days)
                const futureLabels = [...labels];
                const futureData = [...values];
                const marginDataHigh = [...values];
                const marginDataLow = [...values];

                for (let i = 1; i <= 7; i++) {
                    const nextVal = slope * (n - 1 + i) + intercept;
                    const margin = (i * 0.2); 
                    futureData.push(nextVal);
                    marginDataHigh.push(nextVal + margin);
                    marginDataLow.push(nextVal - margin);
                    
                    const lastDate = new Date(futureLabels[futureLabels.length - 1]);
                    lastDate.setDate(lastDate.getDate() + 1);
                    futureLabels.push(lastDate.toISOString().split('T')[0]);
                }

                const accentColor = window.matchMedia('(prefers-color-scheme: dark)').matches ? '#FFFFFF' : '#000000';

                // Initialize Chart
                try {
                    chartRef.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: futureLabels,
                            datasets: [
                                { label: 'History', data: values, borderColor: accentColor, borderWidth: 3, tension: 0.4, pointRadius: 2, order: 1 },
                                { label: 'Prediction', data: futureData, borderColor: accentColor, borderDash: [5, 5], borderWidth: 2, pointRadius: 0, tension: 0.4, order: 2 },
                                { label: 'Margin', data: marginDataHigh, fill: '+1', backgroundColor: 'rgba(120, 120, 120, 0.1)', borderColor: 'transparent', pointRadius: 0, tension: 0.4, order: 3 },
                                { label: 'MarginLow', data: marginDataLow, borderColor: 'transparent', pointRadius: 0, tension: 0.4, order: 4 }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { display: false },
                                zoom: {
                                    zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
                                    pan: { enabled: true, mode: 'x' }
                                }
                            },
                            scales: {
                                x: { grid: { display: false }, ticks: { display: false } }, 
                                y: { grid: { color: 'rgba(200,200,200,0.1)' }, border: { display: false } }
                            }
                        }
                    });
                } catch (err) {
                    console.error("Chart Render Failed:", err);
                }

                return function() { if (chartRef.current) chartRef.current.destroy(); };
            }, [entries, activeKey, unit, theme]);

            return (
                <div className="h-full pt-safe px-4 pb-24 flex flex-col bg-white dark:bg-black">
                    <div className="py-6">
                        <h1 className="text-3xl font-bold dark:text-white px-2">Trends</h1>
                    </div>
                    {/* Metric Selector */}
                    <div className="flex overflow-x-auto no-scrollbar space-x-3 pb-4 px-2">
                        {Object.entries(METRICS).map(([key, m]) => (
                            <button key={key} onClick={() => setActiveKey(key)}
                                className={`flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider border transition-all
                                    ${activeKey === key 
                                        ? `${THEMES[theme].accent} border-transparent shadow-lg` 
                                        : 'bg-gray-50 dark:bg-[#1C1C1E] text-gray-500 border-transparent'}`}>
                                {m.label}
                            </button>
                        ))}
                    </div>
                    {/* Canvas Container */}
                    <div className="flex-1 min-h-0 bg-gray-50 dark:bg-[#1C1C1E] rounded-3xl p-4 relative shadow-inner">
                        <canvas ref={canvasRef} />
                    </div>
                    <div className="text-center text-xs text-gray-400 mt-4 mb-2">
                        Pinch to zoom • Dotted line indicates prediction
                    </div>
                </div>
            );
        };

        // --- Tab: History (Spreadsheet) ---
        const HistoryTab = ({ entries, deleteEntry, theme, unit }) => {
            const sorted = useMemo(() => [...entries].sort((a,b) => new Date(b.date) - new Date(a.date)), [entries]);

            return (
                <div className="h-full pt-safe pb-24 flex flex-col bg-white dark:bg-black">
                     <div className="px-6 py-6 bg-white/95 dark:bg-black/95 backdrop-blur z-20 sticky top-0">
                         <h1 className="text-3xl font-bold dark:text-white">History</h1>
                    </div>
                    <div className="flex-1 overflow-auto relative touch-pan-x touch-pan-y">
                        <table className="border-collapse min-w-full">
                            <thead className="bg-gray-50 dark:bg-[#1C1C1E] sticky-head shadow-sm">
                                <tr>
                                    <th className="sticky-corner bg-gray-50 dark:bg-[#1C1C1E] z-50 p-3 text-left w-12"></th>
                                    <th className="sticky-col bg-gray-50 dark:bg-[#1C1C1E] p-3 text-xs font-bold text-gray-500 uppercase tracking-wider text-left min-w-[100px] shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">Date</th>
                                    {Object.entries(METRICS).map(([key, m]) => (
                                        <th key={key} className="p-3 text-xs font-bold text-gray-500 uppercase tracking-wider text-right min-w-[100px] whitespace-nowrap">
                                            {m.label} <span className="text-[9px] opacity-70">({getUnitLabel(m.unitType, unit)})</span>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100 dark:divide-gray-800">
                                {sorted.map((row) => (
                                    <tr key={row.date} className="bg-white dark:bg-black hover:bg-gray-50 dark:hover:bg-gray-900">
                                        <td className="sticky-col left-0 z-10 bg-white dark:bg-black p-2 text-center">
                                            <button onClick={() => deleteEntry(row.date)} className="w-6 h-6 bg-red-100 text-red-500 rounded-full flex items-center justify-center">
                                                <i data-lucide="minus" className="w-3 h-3"></i>
                                            </button>
                                        </td>
                                        <td className="sticky-col left-8 z-10 bg-white dark:bg-black p-3 text-sm font-medium dark:text-white border-r border-gray-100 dark:border-gray-800 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                            {new Date(row.date).toLocaleDateString(undefined, {month:'numeric', day:'numeric', year:'2-digit'})}
                                        </td>
                                        {Object.entries(METRICS).map(([key, m]) => (
                                            <td key={key} className="p-3 text-right text-sm text-gray-600 dark:text-gray-300">
                                                {formatVal(row[key], m.unitType, unit)}
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- Tab: Goals (Checklist) ---
        const GoalsTab = ({ goals, toggleGoal, theme }) => (
            <div className="h-full pt-safe pb-24 flex flex-col bg-[#F2F2F7] dark:bg-black">
                <div className="px-6 py-6">
                    <h1 className="text-3xl font-bold dark:text-white">Goals</h1>
                </div>
                <div className="bg-white dark:bg-[#1C1C1E] border-y border-gray-200 dark:border-gray-800">
                    {goals.map((g, i) => (
                        <button key={g.id} onClick={() => toggleGoal(g.id)} 
                            className={`w-full flex items-center pl-6 py-3 active:bg-gray-50 dark:active:bg-gray-800 transition-colors ${i !== goals.length - 1 ? 'border-b border-gray-100 dark:border-gray-800' : ''}`}>
                            <div className={`w-6 h-6 rounded-full border-2 mr-4 flex items-center justify-center transition-all ${g.enabled ? `${THEMES[theme].accent} border-transparent` : 'border-gray-300 dark:border-gray-600'}`}>
                                {g.enabled && <i data-lucide="check" className="w-3.5 h-3.5 stroke-[3]"></i>}
                            </div>
                            <div className="flex-1 flex justify-between items-center pr-6">
                                <span className={`text-lg font-medium ${g.enabled ? 'text-gray-900 dark:text-white' : 'text-gray-400'}`}>{g.label}</span>
                                <span className="text-gray-400">{g.target}</span>
                            </div>
                        </button>
                    ))}
                </div>
            </div>
        );

        // --- Tab: Settings ---
        const SettingsTab = ({ settings, setSettings, theme }) => {
            const update = (k, v) => {
                const s = { ...settings, [k]: v };
                setSettings(s);
                db.settings.put({ key: 'config', val: s });
            };
            return (
                <div className="h-full pt-safe px-6 pb-24 bg-[#F2F2F7] dark:bg-black overflow-y-auto">
                    <h1 className="text-3xl font-bold dark:text-white mt-12 mb-8">Settings</h1>
                    <div className="space-y-6">
                        <div className="bg-white dark:bg-[#1C1C1E] rounded-2xl p-4 shadow-sm">
                            <h3 className="text-xs font-bold text-gray-400 uppercase mb-3">Unit System</h3>
                            <div className="flex bg-gray-100 dark:bg-black p-1 rounded-xl">
                                {['imperial', 'metric'].map(u => (
                                    <button key={u} onClick={() => update('unit', u)} 
                                        className={`flex-1 py-2 rounded-lg text-sm font-semibold capitalize transition-all ${settings.unit === u ? 'bg-white dark:bg-gray-800 shadow text-black dark:text-white' : 'text-gray-400'}`}>
                                        {u}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="bg-white dark:bg-[#1C1C1E] rounded-2xl p-4 shadow-sm">
                            <h3 className="text-xs font-bold text-gray-400 uppercase mb-3">Theme</h3>
                            <div className="grid grid-cols-3 gap-3">
                                {Object.values(THEMES).map(t => (
                                    <button key={t.id} onClick={() => update('theme', t.id)} className="flex flex-col items-center gap-2 p-2">
                                        <div className={`w-8 h-8 rounded-full ${t.bg} ring-2 ring-offset-2 dark:ring-offset-gray-900 ${settings.theme === t.id ? 'ring-gray-400' : 'ring-transparent'}`} />
                                        <span className="text-[10px] text-gray-500 font-medium">{t.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Component: Entry Modal (Slide Up) ---
        const EntryModal = ({ close, theme, unit, latest }) => {
            const [data, setData] = useState({ date: new Date().toISOString().split('T')[0] });

            // Initialize form fields based on METRICS config
            useEffect(() => {
                const init = {};
                Object.keys(METRICS).forEach(k => {
                    if(METRICS[k].input) init[k] = '';
                });
                setData(d => ({ ...d, ...init }));
            }, []);

            const handleChange = (key, val) => setData(d => ({ ...d, [key]: val }));

            const save = async () => {
                const entry = { date: data.date };
                
                // 1. Save inputs
                Object.keys(METRICS).forEach(k => {
                    if (METRICS[k].input && data[k]) {
                        entry[k] = fromInput(data[k], METRICS[k].unitType, unit);
                    }
                });
                
                // 2. Perform Calculations (Metric Base)
                const w = entry.weight;
                const bf = entry.bodyFat;
                if (w && bf) {
                    entry.fatMass = w * (bf / 100);
                    entry.leanMass = w - entry.fatMass;
                }
                
                await db.entries.put(entry);
                close(true);
            };

            return (
                <motion.div initial={{ y: '100%' }} animate={{ y: 0 }} exit={{ y: '100%' }} transition={{ type: "spring", damping: 25 }}
                    className="fixed inset-x-0 bottom-0 top-12 z-50 bg-white dark:bg-[#1C1C1E] rounded-t-[32px] flex flex-col shadow-2xl">
                    <div className="flex justify-between items-center p-6 border-b border-gray-100 dark:border-gray-800">
                        <button onClick={() => close(false)} className="text-gray-400 font-medium">Cancel</button>
                        <h2 className="text-lg font-bold dark:text-white">New Entry</h2>
                        <button onClick={save} className={`${THEMES[theme].icon} font-bold`}>Save</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-6 pb-32">
                        <div className="flex justify-center mb-6">
                            <input type="date" value={data.date} onChange={e => handleChange('date', e.target.value)} 
                                className="bg-gray-100 dark:bg-black px-4 py-2 rounded-xl dark:text-white outline-none" />
                        </div>
                        {Object.entries(METRICS).filter(([_, m]) => m.input).map(([key, m]) => (
                            <div key={key} className="bg-gray-50 dark:bg-black p-4 rounded-2xl flex justify-between items-center">
                                <label className="text-sm font-bold text-gray-500 uppercase">{m.label}</label>
                                <div className="flex items-baseline gap-2">
                                    <input type="number" inputMode="decimal"
                                        value={data[key] || ''}
                                        onChange={e => handleChange(key, e.target.value)}
                                        placeholder="-"
                                        className="bg-transparent text-right text-2xl font-light outline-none dark:text-white w-32"
                                    />
                                    <span className="text-xs text-gray-400 font-bold w-6">{getUnitLabel(m.unitType, unit)}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </motion.div>
            );
        };

        // ============================================
        // 4. MAIN APP CONTROLLER
        // ============================================
        const App = () => {
            const [tab, setTab] = useState('today');
            const [prevTab, setPrevTab] = useState('today');
            const [modal, setModal] = useState(false);
            const [entries, setEntries] = useState([]);
            
            // Persistent Settings
            const [settings, setSettings] = useState({ theme: 'monochrome', unit: 'imperial' });
            const [goals, setGoals] = useState(() => Object.keys(METRICS).map((k, i) => ({ id: i, key: k, label: METRICS[k].label, target: 0, enabled: k === 'weight' })));

            // Initialization Effect
            useEffect(() => {
                const init = async () => {
                    const s = await db.settings.get('config');
                    if (s) setSettings(s.val);
                    const g = await db.goals.toArray();
                    if (g.length) setGoals(g);
                    refresh();
                };
                init();
            }, []);

            // Icons & Dark Mode Sync
            useEffect(() => {
                // Ensure icons render after DOM updates
                if (window.lucide) lucide.createIcons();
                
                // Dark Mode Class
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
            }, [tab, modal]);

            const refresh = async () => setEntries(await db.entries.toArray());
            const toggleGoal = async (id) => {
                const g = goals.map(x => x.id === id ? { ...x, enabled: !x.enabled } : x);
                setGoals(g);
                await db.goals.bulkPut(g);
            };

            const switchTab = (t) => { setPrevTab(tab); setTab(t); };
            
            // Animation Direction Logic
            const direction = ['today', 'trends', 'goals', 'history', 'settings'].indexOf(tab) > ['today', 'trends', 'goals', 'history', 'settings'].indexOf(prevTab) ? 1 : -1;

            return (
                <ErrorBoundary>
                    <div className={`h-dvh w-screen overflow-hidden flex flex-col ${THEMES[settings.theme].text.replace('text-', 'selection:bg-')}`}>
                        
                        {/* Header Action: Settings */}
                        <button onClick={() => switchTab('settings')} className="absolute top-4 right-6 z-50 p-2 rounded-full bg-gray-100/50 dark:bg-gray-800/50 backdrop-blur pt-safe">
                            <i data-lucide="settings-2" className="w-5 h-5 opacity-70"></i>
                        </button>

                        {/* Main Content Area with Transitions */}
                        <div className="flex-1 relative bg-[#F2F2F7] dark:bg-black">
                            <AnimatePresence custom={direction} initial={false}>
                                <motion.div key={tab} custom={direction} 
                                    initial={{ x: direction > 0 ? '100%' : '-100%' }} animate={{ x: 0 }} exit={{ x: direction > 0 ? '-20%' : '20%' }} 
                                    transition={{ type: "tween", ease: "circOut", duration: 0.3 }}
                                    className="absolute inset-0 bg-[#F2F2F7] dark:bg-black shadow-2xl">
                                    {tab === 'today' && <TodayTab goals={goals} entries={entries} theme={settings.theme} unit={settings.unit} />}
                                    {tab === 'trends' && <TrendsTab entries={entries} theme={settings.theme} unit={settings.unit} />}
                                    {tab === 'goals' && <GoalsTab goals={goals} toggleGoal={toggleGoal} theme={settings.theme} />}
                                    {tab === 'history' && <HistoryTab entries={entries} deleteEntry={async (d) => { await db.entries.delete(d); refresh(); }} theme={settings.theme} unit={settings.unit} />}
                                    {tab === 'settings' && <SettingsTab settings={settings} setSettings={setSettings} theme={settings.theme} />}
                                </motion.div>
                            </AnimatePresence>
                        </div>

                        {/* Floating Action Button (FAB) */}
                        <div className="fixed bottom-0 left-0 right-0 z-50 flex justify-center pointer-events-none pb-24">
                            <motion.button 
                                animate={{ scale: tab === 'settings' ? 0.8 : 1, filter: tab === 'settings' ? 'grayscale(100%)' : 'none', opacity: tab === 'settings' ? 0.5 : 1 }}
                                onClick={() => tab !== 'settings' && setModal(true)}
                                className={`w-16 h-16 rounded-full ${THEMES[settings.theme].accent} shadow-2xl flex items-center justify-center pointer-events-auto border-4 border-[#F2F2F7] dark:border-black`}>
                                <i data-lucide="plus" className="w-8 h-8"></i>
                            </motion.button>
                        </div>

                        {/* Bottom Navigation */}
                        <div className="fixed bottom-0 left-0 right-0 glass z-40 pb-safe pt-2 h-[88px] flex justify-around items-start border-t border-gray-200 dark:border-gray-800">
                            {['today', 'trends', 'goals', 'history'].map(id => (
                                <button key={id} onClick={() => switchTab(id)} className={`flex flex-col items-center w-16 pt-2 ${tab === id ? THEMES[settings.theme].icon : 'text-gray-400'}`}>
                                    <i data-lucide={id === 'today' ? 'layout-dashboard' : id === 'trends' ? 'activity' : id === 'goals' ? 'target' : 'table-2'} className="w-6 h-6 mb-1"></i>
                                    <span className="text-[10px] font-medium capitalize">{id}</span>
                                </button>
                            ))}
                        </div>

                        {/* Modals */}
                        <AnimatePresence>
                            {modal && (
                                <>
                                    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} 
                                        className="fixed inset-0 bg-black/40 backdrop-blur-sm z-40" onClick={() => setModal(false)} />
                                    <EntryModal close={(r) => { setModal(false); if(r) refresh(); }} theme={settings.theme} unit={settings.unit} latest={entries[entries.length-1]} />
                                </>
                            )}
                        </AnimatePresence>
                    </div>
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GlobalErrorBoundary><App /></GlobalErrorBoundary>);

    </script>
</body>
</html>
