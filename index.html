<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HealthOS</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/180/4a90e2/scale-tool.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            background-color: #F2F2F7;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .dark body { background-color: #000000; }
        
        /* Layout Utilities */
        .pt-safe { padding-top: max(20px, var(--sat)); }
        .pb-safe { padding-bottom: max(20px, var(--sab)); }
        .pb-nav { padding-bottom: calc(max(20px, var(--sab)) + 60px); }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1);
        }
        .dark .glass {
            background: rgba(28, 28, 30, 0.85);
            border-top: 0.5px solid rgba(255,255,255,0.15);
        }
        
        /* No Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Chart Canvas Fix */
        canvas { width: 100% !important; height: 100% !important; }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', blue: '#007AFF' }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- 1. CONSTANTS & THEMES ---
        const THEMES = {
            monochrome: { 
                id: 'monochrome', label: 'Noir', 
                bg: 'bg-black dark:bg-white', text: 'text-black dark:text-white', 
                accent: 'bg-gray-900 dark:bg-white text-white dark:text-black', // Adaptive
                icon: 'text-gray-900 dark:text-white'
            },
            ocean: { id: 'ocean', label: 'Ocean', bg: 'bg-blue-600', text: 'text-blue-600', accent: 'bg-blue-500 text-white', icon: 'text-blue-500' },
            forest: { id: 'forest', label: 'Forest', bg: 'bg-emerald-600', text: 'text-emerald-600', accent: 'bg-emerald-600 text-white', icon: 'text-emerald-600' },
            mint: { id: 'mint', label: 'Mint', bg: 'bg-teal-400', text: 'text-teal-500', accent: 'bg-teal-400 text-white', icon: 'text-teal-400' },
            bubblegum: { id: 'bubblegum', label: 'Bubblegum', bg: 'bg-pink-500', text: 'text-pink-500', accent: 'bg-pink-500 text-white', icon: 'text-pink-500' },
            rose: { id: 'rose', label: 'Rose', bg: 'bg-rose-300', text: 'text-rose-400', accent: 'bg-rose-300 text-white', icon: 'text-rose-400' },
        };

        const METRICS = {
            weight: { label: 'Weight', type: 'mass' },
            bodyFat: { label: 'Body Fat', type: 'percent' },
            leanMass: { label: 'Lean Mass', type: 'mass' } // Auto-calculated
        };

        // --- 2. DATABASE ---
        const db = new Dexie('HealthOS_V3');
        db.version(1).stores({
            entries: 'date, weight, bodyFat', // Stored in KG and %
            settings: 'key',
            goals: 'id'
        });

        // --- 3. UTILS (Universal Unit Logic) ---
        const toDisplay = (val, type, unitSystem) => {
            if (!val || isNaN(val)) return 0;
            if (type === 'percent') return parseFloat(val).toFixed(1);
            // Mass: Storage is KG. 
            if (unitSystem === 'imperial') return (val * 2.20462).toFixed(1);
            return parseFloat(val).toFixed(1); // Metric
        };

        const toStorage = (val, type, unitSystem) => {
            if (!val) return 0;
            const num = parseFloat(val);
            if (type === 'percent') return num;
            // Mass: Input is User Unit, convert to KG
            if (unitSystem === 'imperial') return num / 2.20462;
            return num; 
        };

        const getUnitLabel = (type, unitSystem) => {
            if (type === 'percent') return '%';
            return unitSystem === 'imperial' ? 'lbs' : 'kg';
        };

        const formatDate = (d) => d.toISOString().split('T')[0];

        // --- 4. COMPONENTS ---

        // --- TAB: TODAY ---
        const TodayTab = ({ goals, entries, theme, unit }) => {
            const sorted = useMemo(() => [...entries].sort((a,b) => new Date(a.date) - new Date(b.date)), [entries]);
            const firstEntry = sorted[0];
            const latestEntry = sorted[sorted.length - 1];

            const activeGoals = goals.filter(g => g.enabled);

            return (
                <div className="h-full pt-safe px-6 pb-nav overflow-y-auto no-scrollbar">
                    <div className="mt-12 mb-8">
                        <h2 className="text-gray-500 font-semibold uppercase tracking-wider text-xs mb-1">Dashboard</h2>
                        <h1 className="text-4xl font-bold text-gray-900 dark:text-white tracking-tight">
                            {new Date().toLocaleDateString('en-US', { weekday: 'long' })}
                        </h1>
                        <p className="text-gray-500 text-lg">
                            {new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}
                        </p>
                    </div>

                    <div className="space-y-4">
                        {activeGoals.length === 0 ? (
                            <div className="p-8 text-center border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl">
                                <p className="text-gray-400">No active goals.</p>
                            </div>
                        ) : (
                            activeGoals.map(goal => {
                                const metric = METRICS[goal.key];
                                const currentRaw = latestEntry ? (latestEntry[goal.key] || 0) : 0;
                                const startRaw = firstEntry ? (firstEntry[goal.key] || 0) : currentRaw;
                                
                                // Conversion for Display
                                const currentDisp = toDisplay(currentRaw, metric.type, unit);
                                const startDisp = toDisplay(startRaw, metric.type, unit);
                                const goalDisp = parseFloat(goal.target); // Goal is stored in user unit preference at time of creation? No, let's assume goal is stored in display unit for simplicity, or we convert goal to KG too. 
                                // *Correction*: To keep it simple, let's assume Goal Target is stored in current Unit Preference.
                                
                                const delta = currentDisp - startDisp;
                                const totalJourney = goalDisp - startDisp;
                                const percent = totalJourney !== 0 ? (delta / totalJourney) * 100 : 0;
                                
                                const sign = delta > 0 ? '+' : '';

                                return (
                                    <div key={goal.id} className="bg-white dark:bg-[#1C1C1E] rounded-3xl p-6 shadow-sm relative overflow-hidden">
                                        <div className="flex justify-between items-start mb-4 relative z-10">
                                            <div>
                                                <div className={`text-xs font-bold uppercase tracking-wider mb-1 ${THEMES[theme].icon}`}>{goal.label}</div>
                                                <div className="flex items-baseline gap-2">
                                                    <span className="text-3xl font-bold dark:text-white">{currentDisp}</span>
                                                    <span className="text-sm text-gray-400 font-medium">{getUnitLabel(metric.type, unit)}</span>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className={`text-lg font-bold ${delta > 0 ? 'text-green-500' : 'text-gray-500'}`}>
                                                    {sign}{parseFloat(delta).toFixed(1)} <span className="text-xs">{getUnitLabel(metric.type, unit)}</span>
                                                </div>
                                                <div className="text-xs text-gray-400">Since Start</div>
                                            </div>
                                        </div>
                                        
                                        {/* Progress Bar */}
                                        <div className="relative pt-2">
                                            <div className="flex justify-between text-xs text-gray-400 mb-1 font-medium">
                                                <span>{Math.max(0, Math.min(100, percent)).toFixed(0)}% Done</span>
                                                <span>Goal: {goalDisp}</span>
                                            </div>
                                            <div className="h-3 w-full bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                                                <motion.div 
                                                    initial={{ width: 0 }}
                                                    animate={{ width: `${Math.max(5, Math.min(100, percent))}%` }}
                                                    className={`h-full ${THEMES[theme].bg}`}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                )
                            })
                        )}
                    </div>
                </div>
            );
        };

        // --- TAB: TRENDS ---
        const TrendsTab = ({ entries, unit, theme }) => {
            const [activeMetric, setActiveMetric] = useState('weight');
            const canvasRef = useRef(null);
            const chartInstance = useRef(null);

            // Chart Rendering
            useEffect(() => {
                if (!canvasRef.current || entries.length < 2) return;
                
                const ctx = canvasRef.current.getContext('2d');
                if (chartInstance.current) chartInstance.current.destroy();

                const sorted = [...entries].sort((a,b) => new Date(a.date) - new Date(b.date));
                const labels = sorted.map(e => new Date(e.date).toLocaleDateString(undefined, {month:'short', day:'numeric'}));
                const dataPoints = sorted.map(e => toDisplay(e[activeMetric], METRICS[activeMetric].type, unit));

                const color = window.getComputedStyle(document.body).getPropertyValue('--theme-color') || '#000';

                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            data: dataPoints,
                            borderColor: theme === 'monochrome' ? (document.documentElement.classList.contains('dark') ? '#FFF' : '#000') : '#007AFF', // Fallback color logic handled better in real CSS
                            backgroundColor: 'rgba(100,100,100, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHitRadius: 20,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { display: true, maxTicksLimit: 5 } },
                            y: { grid: { color: 'rgba(200,200,200,0.1)' }, border: { display: false } }
                        }
                    }
                });

                return () => { if(chartInstance.current) chartInstance.current.destroy(); };
            }, [entries, activeMetric, unit, theme]);

            return (
                <div className="h-full pt-safe pb-nav flex flex-col bg-white dark:bg-black">
                     <div className="px-6 py-6">
                        <h1 className="text-3xl font-bold dark:text-white">Trends</h1>
                    </div>
                    
                    {/* Horizontal Selector */}
                    <div className="flex overflow-x-auto no-scrollbar px-6 space-x-4 mb-6">
                        {Object.keys(METRICS).map(key => (
                            <button 
                                key={key}
                                onClick={() => setActiveMetric(key)}
                                className={`flex flex-col items-center flex-shrink-0 p-3 rounded-2xl min-w-[80px] transition-all border
                                    ${activeMetric === key 
                                        ? `${THEMES[theme].accent} border-transparent shadow-lg` 
                                        : 'bg-gray-50 dark:bg-[#1C1C1E] border-transparent text-gray-500'}`}
                            >
                                <span className="text-xs font-bold uppercase tracking-wide">{METRICS[key].label}</span>
                                <div className="mt-1 font-mono text-xs opacity-70">
                                    {getUnitLabel(METRICS[key].type, unit)}
                                </div>
                            </button>
                        ))}
                    </div>

                    {/* Chart Area */}
                    <div className="flex-1 px-4 pb-8 min-h-0">
                        <div className="w-full h-full bg-gray-50 dark:bg-[#1C1C1E] rounded-3xl p-4 relative">
                            {entries.length < 2 ? (
                                <div className="absolute inset-0 flex items-center justify-center text-gray-400 text-sm">
                                    Add more entries to see trends
                                </div>
                            ) : (
                                <canvas ref={canvasRef}></canvas>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- TAB: GOALS ---
        const GoalsTab = ({ goals, toggleGoal, theme, unit }) => {
            return (
                <div className="h-full pt-safe pb-nav flex flex-col bg-[#F2F2F7] dark:bg-black">
                    <div className="px-6 py-6">
                        <h1 className="text-3xl font-bold dark:text-white">Goals</h1>
                    </div>
                    
                    <div className="bg-white dark:bg-[#1C1C1E] border-t border-b border-gray-200 dark:border-gray-800">
                        {goals.map((goal, idx) => (
                            <button 
                                key={goal.id} 
                                onClick={() => toggleGoal(goal.id)}
                                className={`w-full flex items-center pl-6 active:bg-gray-50 dark:active:bg-gray-800 transition-colors
                                    ${idx !== goals.length - 1 ? 'border-b border-gray-100 dark:border-gray-800' : ''}`}
                            >
                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all mr-4
                                    ${goal.enabled 
                                        ? `${THEMES[theme].accent} border-transparent` 
                                        : 'border-gray-300 dark:border-gray-600 bg-transparent'}`}
                                >
                                    {goal.enabled && <i data-lucide="check" className="w-3.5 h-3.5 text-white stroke-[3]"></i>}
                                </div>
                                <div className="flex-1 flex justify-between items-center py-4 pr-6">
                                    <span className={`text-lg ${goal.enabled ? 'text-gray-900 dark:text-white font-medium' : 'text-gray-400'}`}>
                                        {goal.label}
                                    </span>
                                    <span className="text-gray-500 dark:text-gray-400 font-normal">
                                        {goal.target} <span className="text-sm">{goal.unit}</span>
                                    </span>
                                </div>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- TAB: HISTORY ---
        const HistoryTab = ({ entries, updateEntry, deleteEntry, addRow, theme, unit }) => {
            const [isEditing, setIsEditing] = useState(false);

            // Sort entries descending
            const sorted = useMemo(() => [...entries].sort((a,b) => new Date(b.date) - new Date(a.date)), [entries]);

            return (
                <div className="h-full pt-safe pb-nav flex flex-col bg-white dark:bg-black">
                     <div className="px-6 py-4 flex justify-between items-end bg-white/90 dark:bg-black/90 backdrop-blur-sm z-10 sticky top-0">
                         <h1 className="text-3xl font-bold dark:text-white">History</h1>
                        <button 
                            onClick={() => setIsEditing(!isEditing)}
                            className={`w-9 h-9 rounded-full flex items-center justify-center transition-all ${isEditing ? `${THEMES[theme].accent} shadow-md` : 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300'}`}
                        >
                            <i data-lucide={isEditing ? "check" : "pencil"} className="w-4 h-4"></i>
                        </button>
                    </div>

                    <div className="flex-1 overflow-auto relative">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-gray-50 dark:bg-[#1C1C1E] text-gray-500 dark:text-gray-400 text-[10px] uppercase tracking-wider sticky top-0 z-20 shadow-sm">
                                <tr>
                                    <th className={`w-10 pl-4 py-3 transition-all ${!isEditing && 'hidden'}`}></th>
                                    <th className="px-4 py-3 font-semibold">Date</th>
                                    <th className="px-4 py-3 font-semibold text-right">Weight <span className="lowercase">({unit === 'imperial' ? 'lbs' : 'kg'})</span></th>
                                    <th className="px-4 py-3 font-semibold text-right">Body Fat %</th>
                                    <th className="px-4 py-3 font-semibold text-right text-gray-400">LBM <span className="lowercase">({unit === 'imperial' ? 'lbs' : 'kg'})</span></th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100 dark:divide-gray-800">
                                {sorted.map((row) => (
                                    <tr key={row.date} className="group bg-white dark:bg-black">
                                        <td className={`pl-4 py-3 align-middle transition-all ${!isEditing ? 'hidden' : ''}`}>
                                            <button onClick={() => deleteEntry(row.date)} className="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center text-white shadow active:scale-90 transition-transform">
                                                <i data-lucide="minus" className="w-4 h-4"></i>
                                            </button>
                                        </td>
                                        <td className="px-4 py-4">
                                            {isEditing ? (
                                                <input type="date" value={row.date} onChange={(e) => updateEntry(row.date, 'date', e.target.value)}
                                                    className="bg-transparent outline-none dark:text-white text-xs font-mono" />
                                            ) : (
                                                <span className="font-medium text-gray-900 dark:text-white text-sm">{row.date}</span>
                                            )}
                                        </td>
                                        <td className="px-4 py-4 text-right">
                                            {isEditing ? (
                                                <input type="number" inputMode="decimal" 
                                                    value={toDisplay(row.weight, 'mass', unit)}
                                                    onChange={(e) => updateEntry(row.date, 'weight', toStorage(e.target.value, 'mass', unit))}
                                                    className="w-20 bg-blue-50 dark:bg-blue-900/20 rounded px-2 py-1 text-right outline-none dark:text-white text-sm" />
                                            ) : (
                                                <span className="text-gray-900 dark:text-gray-200 font-medium">{toDisplay(row.weight, 'mass', unit)}</span>
                                            )}
                                        </td>
                                        <td className="px-4 py-4 text-right">
                                            {isEditing ? (
                                                <input type="number" inputMode="decimal"
                                                    value={row.bodyFat || ''}
                                                    onChange={(e) => updateEntry(row.date, 'bodyFat', e.target.value)}
                                                    className="w-16 bg-blue-50 dark:bg-blue-900/20 rounded px-2 py-1 text-right outline-none dark:text-white text-sm" />
                                            ) : (
                                                <span className="text-gray-600 dark:text-gray-400">{row.bodyFat ? row.bodyFat + '%' : '-'}</span>
                                            )}
                                        </td>
                                         <td className="px-4 py-4 text-right text-gray-400 text-sm">
                                            {row.leanMass ? toDisplay(row.leanMass, 'mass', unit) : '-'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {isEditing && (
                        <button onClick={addRow} className={`absolute bottom-6 left-6 w-12 h-12 rounded-full ${THEMES[theme].accent} shadow-xl flex items-center justify-center z-30`}>
                            <i data-lucide="plus" className="w-6 h-6"></i>
                        </button>
                    )}
                </div>
            );
        };

        // --- COMPONENT: ENTRY WIZARD (Sheet) ---
        const EntryModal = ({ close, theme, unit, latest }) => {
            // Auto calculate suggestions based on latest
            const [data, setData] = useState({ 
                weight: '', 
                bodyFat: '',
                date: formatDate(new Date()) 
            });

            // Convert Input (User Unit) to Storage (KG) on save
            const save = async () => {
                const weightKG = toStorage(data.weight, 'mass', unit);
                const bf = parseFloat(data.bodyFat);
                
                // Calculate Lean Mass
                let leanMass = 0;
                if(weightKG && bf) {
                    leanMass = weightKG * (1 - (bf/100));
                }

                await db.entries.put({
                    date: data.date,
                    weight: weightKG,
                    bodyFat: bf,
                    leanMass: leanMass
                });
                close(true);
            };

            return (
                <motion.div 
                    initial={{ y: "100%" }} animate={{ y: 0 }} exit={{ y: "100%" }}
                    transition={{ type: "spring", damping: 25, stiffness: 200 }}
                    className="fixed inset-x-0 bottom-0 z-[60] bg-white dark:bg-[#1C1C1E] rounded-t-[32px] p-6 pb-safe pt-4 shadow-2xl h-[85vh]"
                >
                    <div className="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-6" onClick={() => close(false)} />
                    
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-2xl font-bold dark:text-white">New Entry</h2>
                        <input type="date" value={data.date} onChange={e => setData({...data, date: e.target.value})} className="bg-transparent dark:text-white outline-none" />
                    </div>

                    <div className="space-y-6">
                        {/* Weight Step */}
                        <div className="bg-gray-50 dark:bg-black p-6 rounded-3xl">
                            <div className="flex justify-between items-center mb-2">
                                <label className="text-xs font-bold text-gray-500 uppercase">Weight ({unit === 'imperial' ? 'lbs' : 'kg'})</label>
                                {latest && <span className="text-xs text-gray-400">Prev: {toDisplay(latest.weight, 'mass', unit)}</span>}
                            </div>
                            <input 
                                type="number" inputMode="decimal" autoFocus
                                value={data.weight}
                                onChange={e => setData({...data, weight: e.target.value})}
                                placeholder={latest ? toDisplay(latest.weight, 'mass', unit) : "0.0"}
                                className="w-full bg-transparent text-5xl font-light outline-none dark:text-white placeholder-gray-300"
                            />
                        </div>

                        {/* Body Fat Step */}
                        <div className="bg-gray-50 dark:bg-black p-6 rounded-3xl flex items-center justify-between">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase block mb-1">Body Fat %</label>
                                <input 
                                    type="number" inputMode="decimal"
                                    value={data.bodyFat}
                                    onChange={e => setData({...data, bodyFat: e.target.value})}
                                    placeholder={latest ? latest.bodyFat : "--"}
                                    className="bg-transparent text-3xl font-light outline-none dark:text-white w-32 placeholder-gray-300"
                                />
                            </div>
                            {/* Auto calc preview */}
                            <div className="text-right opacity-50">
                                <div className="text-xs uppercase">Lean Mass</div>
                                <div className="font-mono">{data.weight && data.bodyFat ? 
                                    (data.weight * (1 - (data.bodyFat/100))).toFixed(1) : '--'}
                                </div>
                            </div>
                        </div>

                        <button onClick={save} className={`w-full py-4 rounded-2xl font-bold text-white text-lg shadow-lg active:scale-[0.98] transition-transform ${THEMES[theme].accent}`}>
                            Save Entry
                        </button>
                    </div>
                </motion.div>
            );
        };

        // --- TAB: SETTINGS ---
        const SettingsTab = ({ settings, setSettings, theme }) => {
            const update = (k, v) => {
                const s = { ...settings, [k]: v };
                setSettings(s);
                db.settings.put({ key: 'config', val: s });
            };

            return (
                <div className="h-full pt-safe px-6 pb-nav overflow-y-auto bg-[#F2F2F7] dark:bg-black">
                     <h1 className="text-3xl font-bold dark:text-white mt-12 mb-8">Settings</h1>
                     
                     <div className="space-y-6">
                        <section>
                            <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-2">App Theme</h3>
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-2xl p-4 shadow-sm grid grid-cols-3 gap-4">
                                {Object.values(THEMES).map(t => (
                                    <button key={t.id} onClick={() => update('theme', t.id)} className="flex flex-col items-center space-y-2">
                                        <div className={`w-10 h-10 rounded-full ${t.bg} ring-2 ring-offset-2 dark:ring-offset-black transition-all ${settings.theme === t.id ? 'ring-gray-400' : 'ring-transparent'}`}></div>
                                        <span className="text-[10px] font-medium text-gray-500">{t.label}</span>
                                    </button>
                                ))}
                            </div>
                        </section>

                        <section>
                             <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-2">Units</h3>
                             <div className="bg-white dark:bg-[#1C1C1E] rounded-2xl p-1 shadow-sm flex text-sm font-semibold">
                                 <button onClick={() => update('unit', 'imperial')} className={`flex-1 py-2 rounded-xl transition-all ${settings.unit === 'imperial' ? 'bg-gray-100 dark:bg-gray-800 text-black dark:text-white shadow-sm' : 'text-gray-400'}`}>Imperial (lbs)</button>
                                 <button onClick={() => update('unit', 'metric')} className={`flex-1 py-2 rounded-xl transition-all ${settings.unit === 'metric' ? 'bg-gray-100 dark:bg-gray-800 text-black dark:text-white shadow-sm' : 'text-gray-400'}`}>Metric (kg)</button>
                             </div>
                        </section>
                     </div>
                </div>
            );
        };

        // --- MAIN APP SHELL ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('today');
            const [prevTab, setPrevTab] = useState('today');
            const [showModal, setShowModal] = useState(false);
            const [entries, setEntries] = useState([]);
            
            // State
            const [settings, setSettings] = useState({ theme: 'monochrome', unit: 'imperial', mode: 'auto' });
            const [goals, setGoals] = useState([
                { id: 1, label: 'Weight', key: 'weight', target: 170, unit: 'lbs', enabled: true },
                { id: 2, label: 'Body Fat', key: 'bodyFat', target: 12, unit: '%', enabled: true },
            ]);

            // Load Data
            useEffect(() => {
                const init = async () => {
                    const s = await db.settings.get('config');
                    if (s) setSettings(s.val);
                    const g = await db.goals.toArray();
                    if (g.length) setGoals(g);
                    else await db.goals.bulkPut(goals);
                    refreshData();
                    lucide.createIcons();
                };
                init();
            }, []);

            // Dark Mode
            useEffect(() => {
                if (settings.mode === 'dark' || (settings.mode === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [settings.mode]);

            const refreshData = async () => {
                const all = await db.entries.toArray();
                setEntries(all);
            };

            const toggleGoal = async (id) => {
                // Fix freeze: functional update & async
                const idx = goals.findIndex(g => g.id === id);
                if (idx === -1) return;
                const newGoals = [...goals];
                newGoals[idx] = { ...newGoals[idx], enabled: !newGoals[idx].enabled };
                setGoals(newGoals);
                await db.goals.put(newGoals[idx]);
            };
            
            // History Actions
            const updateEntry = async (date, key, val) => {
                if(key === 'date') {
                   const old = await db.entries.get(date);
                   await db.entries.delete(date);
                   await db.entries.put({...old, date: val});
                } else {
                   await db.entries.update(date, { [key]: val });
                }
                refreshData();
            };
            const deleteEntry = async (date) => { await db.entries.delete(date); refreshData(); };
            const addRow = async () => { await db.entries.put({ date: formatDate(new Date()), weight: 0, bodyFat: 0 }); refreshData(); };

            const switchTab = (id) => { setPrevTab(activeTab); setActiveTab(id); };

            // Animations
            const tabs = ['today', 'trends', 'goals', 'history', 'settings'];
            const direction = tabs.indexOf(activeTab) > tabs.indexOf(prevTab) ? 1 : -1;

            return (
                <div className={`h-[100dvh] w-screen overflow-hidden flex flex-col ${THEMES[settings.theme].text.replace('text-', 'selection:bg-')}`}>
                    
                    {/* TOP SETTINGS BUTTON */}
                    <button 
                        onClick={() => switchTab('settings')}
                        className={`absolute top-0 right-0 z-50 pt-safe mt-4 mr-6 p-2 rounded-full transition-colors ${activeTab === 'settings' ? THEMES[settings.theme].icon : 'text-gray-300'}`}
                    >
                        <i data-lucide="settings-2" className="w-6 h-6"></i>
                    </button>

                    {/* CONTENT AREA */}
                    <div className="flex-1 relative bg-[#F2F2F7] dark:bg-black">
                         <AnimatePresence initial={false} custom={direction}>
                            <motion.div
                                key={activeTab}
                                custom={direction}
                                initial={{ x: direction > 0 ? '100%' : '-100%' }}
                                animate={{ x: 0 }}
                                exit={{ x: direction > 0 ? '-25%' : '25%' }}
                                transition={{ type: "tween", ease: "circOut", duration: 0.3 }}
                                className="absolute inset-0 w-full h-full bg-[#F2F2F7] dark:bg-black shadow-2xl"
                            >
                                {activeTab === 'today' && <TodayTab goals={goals} entries={entries} theme={settings.theme} unit={settings.unit} />}
                                {activeTab === 'trends' && <TrendsTab entries={entries} theme={settings.theme} unit={settings.unit} />}
                                {activeTab === 'goals' && <GoalsTab goals={goals} toggleGoal={toggleGoal} theme={settings.theme} unit={settings.unit} />}
                                {activeTab === 'history' && <HistoryTab entries={entries} updateEntry={updateEntry} deleteEntry={deleteEntry} addRow={addRow} theme={settings.theme} unit={settings.unit} />}
                                {activeTab === 'settings' && <SettingsTab settings={settings} setSettings={setSettings} theme={settings.theme} />}
                            </motion.div>
                        </AnimatePresence>
                    </div>

                    {/* BOTTOM NAV */}
                    <div className="fixed bottom-0 left-0 right-0 z-40">
                        {/* FAB */}
                        <div className="absolute bottom-[80px] left-0 right-0 flex justify-center pointer-events-none">
                            <motion.button
                                initial={false}
                                animate={{ 
                                    y: activeTab === 'settings' ? 74 : 0, 
                                    scale: activeTab === 'settings' ? 0.6 : 1,
                                    filter: activeTab === 'settings' ? 'grayscale(100%) brightness(0.5)' : 'none'
                                }}
                                onClick={() => activeTab !== 'settings' && setShowModal(true)}
                                className={`w-16 h-16 rounded-full ${THEMES[settings.theme].accent} shadow-2xl shadow-black/20 flex items-center justify-center pointer-events-auto border-4 border-[#F2F2F7] dark:border-black`}
                                style={{ pointerEvents: activeTab === 'settings' ? 'none' : 'auto' }}
                            >
                                <i data-lucide="plus" className="w-8 h-8"></i>
                            </motion.button>
                        </div>

                        {/* BAR */}
                        <div className="glass pb-safe pt-2 h-[85px] px-2 flex justify-between items-start border-t border-gray-200 dark:border-gray-800">
                             <NavBtn id="today" icon="layout-dashboard" label="Today" active={activeTab} set={switchTab} theme={settings.theme} />
                             <NavBtn id="trends" icon="activity" label="Trends" active={activeTab} set={switchTab} theme={settings.theme} />
                             <div className="w-16" /> {/* Spacer */}
                             <NavBtn id="goals" icon="target" label="Goals" active={activeTab} set={switchTab} theme={settings.theme} />
                             <NavBtn id="history" icon="table-2" label="History" active={activeTab} set={switchTab} theme={settings.theme} />
                        </div>
                    </div>

                    {/* MODAL */}
                    <AnimatePresence>
                        {showModal && (
                            <>
                                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 bg-black/30 backdrop-blur-sm z-50" onClick={() => setShowModal(false)} />
                                <EntryModal close={(ref) => { setShowModal(false); if(ref) refreshData(); }} theme={settings.theme} unit={settings.unit} latest={entries[entries.length-1]} />
                            </>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const NavBtn = ({ id, icon, label, active, set, theme }) => (
            <button onClick={() => set(id)} className={`flex-1 flex flex-col items-center justify-center pt-2 transition-colors ${active === id ? THEMES[theme].icon : 'text-gray-400'}`}>
                <i data-lucide={icon} className="w-6 h-6 mb-1"></i>
                <span className="text-[10px] font-medium">{label}</span>
            </button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <script>
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(() => {});
    </script>
</body>
</html>
