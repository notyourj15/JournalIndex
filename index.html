<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Health Journal</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; 
            background-color: #F2F2F7;
            overflow: hidden; 
            overscroll-behavior: none;
        }
        .dark body { background-color: #000000; }
        .safe-pt { padding-top: max(20px, var(--safe-top)); }
        .safe-pb { padding-bottom: max(20px, var(--safe-bottom)); }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .dark .glass { background: rgba(28, 28, 30, 0.8); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Spreadsheet Styling */
        table { border-collapse: separate; border-spacing: 0; }
        th, td { border-bottom: 0.5px solid #E5E5EA; }
        .dark th, .dark td { border-bottom: 0.5px solid #38383A; }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { blue: '#007AFF', green: '#34C759', mono: '#1C1C1E' }
                    }
                }
            }
        }
    </script>
</head>
<body class="transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // Link Framer Motion from Window
        const { motion, AnimatePresence } = window.Motion;
        const { useState, useEffect, useMemo } = React;

        // --- 1. CONFIG ---
        const METRICS = [
            { key: 'weight', label: 'Weight', unit: 'lb', target: 180 },
            { key: 'bodyFat', label: 'Body Fat', unit: '%', target: 15 },
            { key: 'visceral', label: 'Visceral', unit: 'lvl', target: 8 },
            { key: 'muscle', label: 'Muscle', unit: '%', target: 40 },
            { key: 'water', label: 'Water', unit: '%', target: 60 },
            { key: 'bone', label: 'Bone', unit: 'lb', target: 8 },
            { key: 'bmr', label: 'BMR', unit: 'kcal', target: 2000 }
        ];

        const THEMES = {
            blue: { bg: 'bg-[#007AFF]', text: 'text-[#007AFF]', ring: 'ring-[#007AFF]' },
            green: { bg: 'bg-[#34C759]', text: 'text-[#34C759]', ring: 'ring-[#34C759]' },
            monochrome: { bg: 'bg-[#1C1C1E]', text: 'text-[#1C1C1E]', ring: 'ring-[#1C1C1E]' }
        };

        // --- 2. DB ---
        const db = new Dexie('HealthJournal_V3');
        db.version(1).stores({ 
            entries: 'date',
            settings: 'id',
            goals: 'key' 
        });

        // --- 3. COMPONENTS ---

        const App = () => {
            const [tab, setTab] = useState('today');
            const [prevTab, setPrevTab] = useState('today');
            const [showModal, setShowModal] = useState(false);
            const [entries, setEntries] = useState([]);
            const [settings, setSettings] = useState({ theme: 'blue', mode: 'light', unit: 'imperial' });
            const [activeGoals, setActiveGoals] = useState(['weight', 'bodyFat']);

            useEffect(() => {
                const load = async () => {
                    const s = await db.settings.get(1);
                    if (s) setSettings(s.data);
                    const g = await db.goals.toArray();
                    if (g.length) setActiveGoals(g.map(item => item.key));
                    refreshData();
                };
                load();
            }, []);

            const refreshData = async () => {
                const data = await db.entries.orderBy('date').reverse().toArray();
                setEntries(data);
                lucide.createIcons();
            };

            const switchTab = (newTab) => {
                setPrevTab(tab);
                setTab(newTab);
            };

            const direction = METRICS.findIndex(m => m.key === tab) > METRICS.findIndex(m => m.key === prevTab) ? 1 : -1;

            return (
                <div className={`${settings.mode === 'dark' ? 'dark' : ''} h-screen flex flex-col bg-[#F2F2F7] dark:bg-black text-black dark:text-white`}>
                    
                    {/* View Container */}
                    <main className="flex-1 relative safe-pt overflow-hidden">
                        <AnimatePresence initial={false} custom={direction}>
                            <motion.div
                                key={tab}
                                custom={direction}
                                initial={{ x: direction * 100 + '%', opacity: 0 }}
                                animate={{ x: 0, opacity: 1 }}
                                exit={{ x: direction * -100 + '%', opacity: 0 }}
                                transition={{ type: 'spring', damping: 25, stiffness: 200 }}
                                className="absolute inset-0 w-full h-full p-6"
                            >
                                {tab === 'today' && <Dashboard entries={entries} activeGoals={activeGoals} settings={settings} />}
                                {tab === 'history' && <History entries={entries} refresh={refreshData} settings={settings} />}
                                {tab === 'goals' && <Goals active={activeGoals} toggle={(key) => {
                                    const next = activeGoals.includes(key) ? activeGoals.filter(k => k !== key) : [...activeGoals, key];
                                    setActiveGoals(next);
                                    db.goals.clear().then(() => db.goals.bulkPut(next.map(key => ({key}))));
                                }} settings={settings} />}
                                {tab === 'settings' && <Settings settings={settings} setSettings={(s) => {
                                    setSettings(s);
                                    db.settings.put({id: 1, data: s});
                                }} />}
                            </motion.div>
                        </AnimatePresence>
                    </main>

                    {/* Navigation Bar */}
                    <nav className="glass border-t border-[#C6C6C8] dark:border-[#38383A] h-[88px] safe-pb flex justify-around items-center px-4 z-50">
                        <NavBtn id="today" icon="layout-grid" label="Today" active={tab} set={switchTab} theme={settings.theme} />
                        <NavBtn id="history" icon="table" label="History" active={tab} set={switchTab} theme={settings.theme} />
                        
                        <div className="w-16 flex justify-center">
                            {tab !== 'settings' && (
                                <button 
                                    onClick={() => setShowModal(true)}
                                    className={`w-14 h-14 rounded-full ${THEMES[settings.theme].bg} text-white shadow-lg flex items-center justify-center -mt-10 border-[5px] border-[#F2F2F7] dark:border-black active:scale-90 transition-transform`}
                                >
                                    <i data-lucide="plus" className="w-8 h-8"></i>
                                </button>
                            )}
                        </div>

                        <NavBtn id="goals" icon="check-circle" label="Goals" active={tab} set={switchTab} theme={settings.theme} />
                        <NavBtn id="settings" icon="settings" label="Settings" active={tab} set={switchTab} theme={settings.theme} />
                    </nav>

                    {/* Entry Modal */}
                    <AnimatePresence>
                        {showModal && <EntryModal close={(r) => { setShowModal(false); if(r) refreshData(); }} theme={settings.theme} />}
                    </AnimatePresence>
                </div>
            );
        };

        const NavBtn = ({ id, icon, label, active, set, theme }) => (
            <button onClick={() => set(id)} className={`flex flex-col items-center w-12 transition-colors ${active === id ? THEMES[theme].text : 'text-[#8E8E93]'}`}>
                <i data-lucide={icon} className="w-6 h-6"></i>
                <span className="text-[10px] font-medium mt-1">{label}</span>
            </button>
        );

        // --- DASHBOARD VIEW ---
        const Dashboard = ({ entries, activeGoals, settings }) => {
            const last = entries[0] || {};
            return (
                <div className="space-y-6 h-full overflow-y-auto no-scrollbar pb-24">
                    <header>
                        <h2 className="text-[#8E8E93] font-semibold text-sm uppercase tracking-tight">Overview</h2>
                        <h1 className="text-3xl font-bold">Health Status</h1>
                    </header>
                    <div className="grid gap-4">
                        {activeGoals.map(key => {
                            const m = METRICS.find(i => i.key === key);
                            const val = last[key] || 0;
                            const progress = Math.min(100, (val / m.target) * 100);
                            return (
                                <div key={key} className="bg-white dark:bg-[#1C1C1E] p-4 rounded-2xl shadow-sm">
                                    <div className="flex justify-between items-end mb-2">
                                        <span className="font-semibold text-gray-500">{m.label}</span>
                                        <span className="text-xl font-bold">{val}<span className="text-xs ml-1 text-gray-400">{m.unit}</span></span>
                                    </div>
                                    <div className="h-2 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                                        <div className={`h-full ${THEMES[settings.theme].bg} transition-all duration-1000`} style={{ width: `${progress}%` }} />
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- SPREADSHEET HISTORY ---
        const History = ({ entries, refresh, settings }) => {
            const [editMode, setEditMode] = useState(false);

            const update = async (date, key, val) => {
                await db.entries.update(date, { [key]: parseFloat(val) || 0 });
                refresh();
            };

            const remove = async (date) => {
                if(confirm('Delete entry?')) { await db.entries.delete(date); refresh(); }
            };

            return (
                <div className="flex flex-col h-full bg-white dark:bg-[#1C1C1E] rounded-3xl overflow-hidden shadow-xl">
                    <div className="p-4 flex justify-between items-center border-b dark:border-gray-800">
                        <span className="font-bold">Journal Spreadsheet</span>
                        <button onClick={() => setEditMode(!editMode)} className={`p-2 rounded-full ${editMode ? THEMES[settings.theme].bg + ' text-white' : 'bg-gray-100 dark:bg-gray-800'}`}>
                            <i data-lucide={editMode ? 'check' : 'edit-3'} className="w-5 h-5"></i>
                        </button>
                    </div>
                    <div className="flex-1 overflow-auto">
                        <table className="w-full text-sm">
                            <thead className="sticky top-0 bg-gray-50 dark:bg-black z-10">
                                <tr>
                                    {editMode && <th className="p-3 w-10"></th>}
                                    <th className="p-3 text-left">Date</th>
                                    {METRICS.map(m => <th key={m.key} className="p-3 text-right">{m.label}</th>)}
                                </tr>
                            </thead>
                            <tbody>
                                {entries.map(e => (
                                    <tr key={e.date}>
                                        {editMode && <td className="p-3"><button onClick={() => remove(e.date)} className="text-red-500"><i data-lucide="minus-circle" className="w-5 h-5"></i></button></td>}
                                        <td className="p-3 whitespace-nowrap font-medium">{e.date}</td>
                                        {METRICS.map(m => (
                                            <td key={m.key} className="p-0 border-l dark:border-gray-800">
                                                {editMode ? (
                                                    <input type="number" defaultValue={e[m.key]} onBlur={(evt) => update(e.date, m.key, evt.target.value)} className="w-full p-3 text-right bg-transparent outline-none focus:bg-blue-50 dark:focus:bg-blue-900/20" />
                                                ) : (
                                                    <div className="p-3 text-right">{e[m.key] || '-'}</div>
                                                )}
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- GOALS TAB ---
        const Goals = ({ active, toggle, settings }) => (
            <div className="space-y-4">
                <h1 className="text-3xl font-bold mb-6">Tracked Goals</h1>
                <div className="bg-white dark:bg-[#1C1C1E] rounded-3xl divide-y dark:divide-gray-800 overflow-hidden shadow-sm">
                    {METRICS.map(m => (
                        <div key={m.key} onClick={() => toggle(m.key)} className="flex items-center p-5 active:bg-gray-50 dark:active:bg-gray-800 transition-colors">
                            <div className={`w-6 h-6 rounded-full border-2 mr-4 flex items-center justify-center ${active.includes(m.key) ? THEMES[settings.theme].bg + ' border-transparent' : 'border-gray-300'}`}>
                                {active.includes(m.key) && <i data-lucide="check" className="w-4 h-4 text-white"></i>}
                            </div>
                            <span className={`text-lg ${active.includes(m.key) ? 'font-semibold' : 'text-gray-400'}`}>{m.label}</span>
                            <span className="ml-auto text-gray-400 font-mono text-sm">{m.target} {m.unit}</span>
                        </div>
                    ))}
                </div>
            </div>
        );

        // --- SETTINGS ---
        const Settings = ({ settings, setSettings }) => (
            <div className="space-y-8">
                <h1 className="text-3xl font-bold">Preferences</h1>
                <div className="bg-white dark:bg-[#1C1C1E] rounded-2xl p-6 space-y-6 shadow-sm">
                    <div className="flex justify-between items-center">
                        <span>Theme Color</span>
                        <div className="flex gap-3">
                            {['blue', 'green', 'monochrome'].map(t => (
                                <button key={t} onClick={() => setSettings({...settings, theme: t})} className={`w-8 h-8 rounded-full ${THEMES[t].bg} ${settings.theme === t ? 'ring-4 ring-gray-300' : ''}`} />
                            ))}
                        </div>
                    </div>
                    <div className="flex justify-between items-center">
                        <span>Appearance</span>
                        <select value={settings.mode} onChange={e => setSettings({...settings, mode: e.target.value})} className="bg-gray-100 dark:bg-black p-2 rounded-lg outline-none">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                </div>
            </div>
        );

        // --- NEW ENTRY MODAL ---
        const EntryModal = ({ close, theme }) => {
            const [vals, setVals] = useState({ date: new Date().toISOString().split('T')[0] });
            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 z-[100] bg-black/50 flex items-end">
                    <motion.div initial={{ y: '100%' }} animate={{ y: 0 }} exit={{ y: '100%' }} className="w-full bg-white dark:bg-[#1C1C1E] rounded-t-[32px] p-8 pb-12 shadow-2xl overflow-y-auto max-h-[90vh]">
                        <div className="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-8" />
                        <h2 className="text-2xl font-bold text-center mb-8">Daily Journal</h2>
                        <div className="grid gap-4 mb-8">
                            <input type="date" value={vals.date} onChange={e => setVals({...vals, date: e.target.value})} className="p-4 bg-gray-50 dark:bg-black rounded-xl w-full font-bold text-center" />
                            {METRICS.map(m => (
                                <div key={m.key} className="flex items-center bg-gray-50 dark:bg-black p-4 rounded-xl">
                                    <label className="flex-1 font-medium">{m.label}</label>
                                    <input type="number" placeholder="0" onChange={e => setVals({...vals, [m.key]: parseFloat(e.target.value) || 0})} className="bg-transparent text-right w-24 font-bold outline-none" />
                                    <span className="ml-2 text-gray-400 text-xs">{m.unit}</span>
                                </div>
                            ))}
                        </div>
                        <button onClick={() => { db.entries.put(vals); close(true); }} className={`w-full p-4 rounded-2xl text-white font-bold text-lg shadow-lg ${THEMES[theme].bg}`}>Save Entry</button>
                        <button onClick={() => close(false)} className="w-full mt-4 p-2 text-gray-400">Cancel</button>
                    </motion.div>
                </motion.div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
