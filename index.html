<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Body Journal</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Journal">
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/180/4a90e2/scale-tool.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom "Paper" Aesthetic & Animations */
        body { background-color: #F5F5F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        
        /* Smooth Transitions */
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
        .fade-exit { opacity: 1; transform: scale(1); }
        .fade-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 200ms, transform 200ms; }
        
        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Card Elevation */
        .journal-card { box-shadow: 0 4px 20px -2px rgba(0,0,0,0.05); background: white; border-radius: 16px; }
        
        /* Floating Input */
        .floating-input:focus ~ label, .floating-input:not(:placeholder-shown) ~ label { transform: translateY(-120%) scale(0.85); color: #6366F1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- DATABASE LAYER (Dexie.js) ---
        const db = new Dexie('HealthJournalDB');
        db.version(1).stores({
            entries: 'date, weight, bodyFat, *tags'
        });

        // --- UTILS ---
        const formatDate = (d) => d.toISOString().split('T')[0];
        const toKg = (lb) => (lb * 0.453592).toFixed(1);
        
        // --- COMPONENTS ---

        // 1. Tab Bar
        const TabBar = ({ active, setTab }) => {
            const tabs = [
                { id: 'today', icon: 'pen-tool', label: 'Today' },
                { id: 'trends', icon: 'line-chart', label: 'Trends' },
                { id: 'history', icon: 'history', label: 'History' },
                { id: 'settings', icon: 'settings', label: 'Settings' }
            ];

            useEffect(() => { lucide.createIcons(); }, [active]);

            return (
                <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-gray-200 pb-safe pt-2 px-6 flex justify-between items-center z-50 h-[80px]">
                    {tabs.map(t => (
                        <button key={t.id} onClick={() => setTab(t.id)} className={`flex flex-col items-center space-y-1 w-16 transition-colors duration-200 ${active === t.id ? 'text-indigo-600' : 'text-gray-400'}`}>
                            <i data-lucide={t.icon} className="w-6 h-6"></i>
                            <span className="text-[10px] font-medium tracking-wide">{t.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        // 2. Today Tab (Wizard Flow)
        const TodayTab = () => {
            const [step, setStep] = useState(0);
            const [data, setData] = useState({ date: formatDate(new Date()), weight: '', bodyFat: '', notes: '' });
            const [saved, setSaved] = useState(false);

            const handleNext = () => setStep(s => s + 1);
            const handleChange = (f, v) => setData(p => ({ ...p, [f]: v }));
            
            const saveEntry = async () => {
                await db.entries.put({ ...data, weight: parseFloat(data.weight), bodyFat: parseFloat(data.bodyFat) });
                setSaved(true);
            };

            if (saved) return (
                <div className="h-screen flex flex-col items-center justify-center p-8 bg-indigo-50 text-center animate-fade-in">
                    <div className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center text-white mb-4 shadow-lg">
                        <i data-lucide="check" className="w-8 h-8"></i>
                    </div>
                    <h2 className="text-2xl font-bold text-gray-800">Entry Logged</h2>
                    <p className="text-gray-500 mt-2">See you tomorrow.</p>
                    <button onClick={() => setSaved(false)} className="mt-8 text-indigo-600 font-medium">Edit Entry</button>
                </div>
            );

            return (
                <div className="pt-12 px-6 pb-32 max-w-md mx-auto min-h-screen">
                    <h1 className="text-3xl font-bold text-gray-900 mb-1">{new Date().toLocaleDateString('en-US', { weekday: 'long' })}</h1>
                    <p className="text-gray-500 mb-8 text-lg">{new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</p>

                    {/* Step 1: Weight */}
                    <div className={`journal-card p-6 mb-4 transition-all duration-500 ${step > 0 ? 'opacity-50 scale-95' : 'opacity-100 scale-100'}`}>
                        <label className="text-xs font-bold text-gray-400 uppercase tracking-wider">Step 1</label>
                        <h3 className="text-xl font-semibold text-gray-800 mb-4">Morning Weight</h3>
                        <div className="flex items-baseline space-x-2">
                            <input 
                                type="number" 
                                value={data.weight} 
                                onChange={(e) => handleChange('weight', e.target.value)}
                                placeholder="0.0" 
                                className="w-full text-5xl font-light text-indigo-600 bg-transparent outline-none tabular-nums placeholder-gray-200"
                                autoFocus
                            />
                            <span className="text-xl text-gray-400 font-medium">lbs</span>
                        </div>
                        {step === 0 && data.weight && (
                            <button onClick={handleNext} className="mt-6 w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold shadow-lg shadow-indigo-200 active:scale-95 transition-transform">
                                Next
                            </button>
                        )}
                    </div>

                    {/* Step 2: Metrics */}
                    {step >= 1 && (
                        <div className="journal-card p-6 mb-4 animate-fade-in">
                            <label className="text-xs font-bold text-gray-400 uppercase tracking-wider">Step 2</label>
                            <h3 className="text-xl font-semibold text-gray-800 mb-4">Composition</h3>
                            <div className="relative pt-4">
                                <input 
                                    type="number" 
                                    value={data.bodyFat} 
                                    onChange={(e) => handleChange('bodyFat', e.target.value)}
                                    className="floating-input w-full bg-gray-50 border-b-2 border-gray-200 p-2 text-xl outline-none focus:border-indigo-500 transition-colors"
                                    placeholder=" "
                                />
                                <label className="absolute left-2 top-2 text-gray-400 text-lg transition-all pointer-events-none">Body Fat %</label>
                            </div>
                            {step === 1 && (
                                <button onClick={handleNext} className="mt-6 w-full py-3 bg-gray-900 text-white rounded-xl font-semibold active:scale-95 transition-transform">
                                    Next
                                </button>
                            )}
                        </div>
                    )}

                    {/* Step 3: Notes & Save */}
                    {step >= 2 && (
                        <div className="journal-card p-6 animate-fade-in">
                            <label className="text-xs font-bold text-gray-400 uppercase tracking-wider">Step 3</label>
                            <h3 className="text-xl font-semibold text-gray-800 mb-4">Notes</h3>
                            <textarea 
                                value={data.notes} 
                                onChange={(e) => handleChange('notes', e.target.value)}
                                className="w-full h-24 bg-gray-50 rounded-lg p-3 text-gray-700 outline-none resize-none focus:ring-2 ring-indigo-100"
                                placeholder="How do you feel today?"
                            ></textarea>
                            <button onClick={saveEntry} className="mt-6 w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold shadow-lg shadow-indigo-200 active:scale-95 transition-transform">
                                Complete Entry
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // 3. Trends Tab (Chart.js)
        const TrendsTab = () => {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                const loadData = async () => {
                    const entries = await db.entries.orderBy('date').toArray();
                    if (!entries.length) return;

                    // Simple Moving Average for "Projection"
                    const weights = entries.map(e => e.weight);
                    const dates = entries.map(e => e.date.slice(5)); // MM-DD
                    
                    const ctx = canvasRef.current.getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'Weight (lbs)',
                                data: weights,
                                borderColor: '#4F46E5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 0,
                                pointHitRadius: 20
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { grid: { display: false } },
                                y: { border: { display: false }, grid: { color: '#f3f4f6' } }
                            }
                        }
                    });
                };
                loadData();
            }, []);

            return (
                <div className="h-screen pt-12 px-4 pb-32 flex flex-col">
                    <h1 className="text-3xl font-bold text-gray-900 mb-6 px-2">Trends</h1>
                    <div className="journal-card flex-1 p-4 h-64 relative">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        };

        // 4. Settings Tab (Data Safety)
        const SettingsTab = () => {
            const exportData = async () => {
                const allData = await db.entries.toArray();
                const blob = new Blob([JSON.stringify(allData, null, 2)], {type : 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `journal-backup-${new Date().toISOString()}.json`;
                a.click();
            };

            return (
                <div className="pt-12 px-6 pb-32">
                    <h1 className="text-3xl font-bold text-gray-900 mb-8">Settings</h1>
                    
                    <div className="space-y-4">
                        <div className="journal-card p-4 flex justify-between items-center">
                            <div>
                                <h4 className="font-semibold text-gray-800">Export Data</h4>
                                <p className="text-xs text-gray-500">Save JSON backup to device</p>
                            </div>
                            <button onClick={exportData} className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium">Export</button>
                        </div>
                         <div className="journal-card p-4">
                            <h4 className="font-semibold text-gray-800 mb-2">Storage Info</h4>
                            <p className="text-sm text-gray-600">Using IndexedDB (Safe Local Storage)</p>
                            <p className="text-xs text-green-600 mt-1 flex items-center"><i data-lucide="shield" className="w-3 h-3 mr-1"></i> Data is encrypted by device OS</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [activeTab, setTab] = useState('today');
            
            return (
                <div className="min-h-screen bg-[#F5F5F7]">
                    {activeTab === 'today' && <TodayTab />}
                    {activeTab === 'trends' && <TrendsTab />}
                    {activeTab === 'history' && <div className="pt-20 text-center text-gray-400">History List Component</div>}
                    {activeTab === 'settings' && <SettingsTab />}
                    <TabBar active={activeTab} setTab={setTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <script>
        // Register Service Worker for Offline capability
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Failed', err));
            });
        }
    </script>
</body>
</html>
